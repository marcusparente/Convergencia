---
title: "Women Homicide Rate"
author: "Marcus"
date: "2024-06-10"
output: html_document
---

```{r message=FALSE}
library(convergEU)
library(knitr)
library(tibble)
library(tidyverse)
library(eurostat)
library(purrr)
library(tidyr)
library(ggplot2)
library(kableExtra)
options(kableExtra.auto_format = FALSE)
library(caTools)
library(broom)
library(gridExtra)
library(flextable)
library(flexmix)
library(formattable) 
library(officer)
library(leaflet)
library(magrittr)
library(leaflet.extras)
library(png)
library(purrr)
library(htmltools)
library(htmlwidgets)
library(rmarkdown)
library(webshot)
library(webshot2)
```

```{r}
homicide_rate_women_states = read.csv("homicide_rate_women_states.csv")
head(homicide_rate_women_states)
```


### Beta_convergence

```{r}
c(min(homicide_rate_women_states$time), max(homicide_rate_women_states$time))
```


```{r}
empBC = beta_conv(homicide_rate_women_states,
                  time_0 = 1980,
                  time_t = 2021,
                  all_within = FALSE,
                  timeName = 'time')
empBC
```


```{r message = FALSE}
qplot(empBC$res$workTB$indic,
empBC$res$workTB$deltaIndic,
xlab="log-Indicator",
ylab="Delta-log-indicator") +
geom_abline(intercept = as.numeric(empBC$res$summary[1,2]),
slope = as.numeric(empBC$res$summary[2,2]),
colour = "red") +
geom_text(aes(label=empBC$res$workTB$countries),
hjust=0, vjust=0,colour="blue")
```

### Sigma_convergence

```{r}
mySTB <- sigma_conv(homicide_rate_women_states, timeName="time")
mySTB

```

### Departure Mean

```{r}
res <- departure_mean(oriTB = homicide_rate_women_states, sigmaTB = mySTB$res)
names(res$res)

```

```{r}
res$res$departures
```


```{r}
res$res$squaredContrib
```

```{r}
res$res$devianceContrib
```

```{r}
myGG <- graph_departure(res$res$departures,
timeName = "time",
displace = 0.25,
displaceh = 0.45,
dimeFontNum = 4,
myfont_scale = 1.35,
x_angle = 45,
color_rect = c("-1"='red1', "0"='gray80',"1"='lightskyblue1'),
axis_name_y = "Countries",
axis_name_x = "Time",
alpha_color = 0.9
)

myGG
```

```{r}
myGG <- graph_departure(res$res$departures[,1:10],
timeName = "time",
displace = 0.25,
displaceh = 0.45,
dimeFontNum = 4,
myfont_scale = 1.35,
x_angle = 45,
color_rect = c("-1"='red1', "0"='gray80',"1"='lightskyblue1'),
axis_name_y = "Countries",
axis_name_x = "Time",
alpha_color = 0.29
)

myGG
```

### Gamma_convergence

```{r}
gamma_conv(homicide_rate_women_states,last=2021,ref=1980,timeName="time")
```

### Delta_convergence

```{r}
delta_conv(homicide_rate_women_states,"time")
```

### Scoreboard

```{r}
resTB <- scoreb_yrs(homicide_rate_women_states,timeName = "time")
resTB
```

```{r}
selectedCountry <- "X11"
timeName <- "time"
myx_angle <- 45
outSig <- sigma_conv(homicide_rate_women_states, timeName = timeName,
time_0=1980,time_t=2021)
miniY <- min(homicide_rate_women_states[,- which(names(homicide_rate_women_states) == timeName )])
maxiY <- max(homicide_rate_women_states[,- which(names(homicide_rate_women_states) == timeName )])
estrattore<- homicide_rate_women_states[,timeName] >= 1980 & homicide_rate_women_states[,timeName] <= 2021
ttmp <- cbind(outSig$res, dplyr::select(homicide_rate_women_states[estrattore,], -contains(timeName)))

myG2 <-
ggplot(ttmp) + ggtitle(
paste("Brazil average (black, solid) and country",selectedCountry ," (red, dotted)") )+
geom_line(aes(x=ttmp[,timeName], y =ttmp[,"mean"]),colour="black") +
geom_point(aes(x=ttmp[,timeName],y =ttmp[,"mean"]),colour="black") +
# geom_line()+geom_point()+
ylim(c(miniY,maxiY)) + xlab("Year") +ylab("Indicator") +
theme(legend.position = "none")+
# add countries
geom_line( aes(x=ttmp[,timeName], y = ttmp[,"X11"],colour="red"),linetype="dotted") +
geom_point( aes(x=ttmp[,timeName], y = ttmp[,"X11"],colour="red")) +
ggplot2::scale_x_continuous(breaks = ttmp[,timeName],
labels = ttmp[,timeName]) +
ggplot2::theme(
axis.text.x=ggplot2::element_text(
#size = ggplot2::rel(myfont_scale ),
angle = myx_angle
#vjust = 1,
#hjust=1
))
myG2

```

```{r}
obe_lvl <- scoreb_yrs(homicide_rate_women_states, timeName = timeName)$res$sco_level_num
# select subset of time
estrattore <- obe_lvl[,timeName] >= 1980 & obe_lvl[,timeName] <= 2021
scobelvl <- obe_lvl[estrattore,]
my_MSstd <- ms_dynam(scobelvl,
timeName = "time",
displace = 0.25,
displaceh = 0.45,
dimeFontNum = 3,
myfont_scale = 1.35,
x_angle = 45,
axis_name_y = "States",
axis_name_x = "Time",
alpha_color = 0.9
)

my_MSstd

```
